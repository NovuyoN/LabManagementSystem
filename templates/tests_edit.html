{% extends "base.html" %}
{% block title %}Edit Test Record | Lab Management System{% endblock %}
{% block content %}

<div class="container mt-4" style="max-width: 760px;">
  <div class="card shadow-sm border-0 p-4">
    <h3 class="mb-3 text-center text-primary">Edit Test Record</h3>

    <form method="POST" enctype="multipart/form-data">
      <!-- Patient Info -->
      <div class="mb-3">
        <label class="form-label fw-semibold">Patient Name</label>
        <input
          type="text"
          class="form-control"
          name="patient_name"
          value="{{ test.patient_name }}"
          required
        >
      </div>

      <!-- Test Type -->
      <div class="mb-3">
        <label class="form-label fw-semibold">Test Type</label>
        <input
          type="text"
          class="form-control"
          name="test_type"
          value="{{ test.test_type }}"
          required
        >
      </div>

      <!-- Test Category -->
      <div class="mb-3">
        <label class="form-label fw-semibold">Test Category</label>
        <select name="test_category_id" class="form-select">
          <option value="">-- Select Category --</option>
          {% for cat in categories %}
            <option value="{{ cat.id }}" {% if test.test_category_id == cat.id %}selected{% endif %}>
              {{ cat.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Test Result -->
      <div class="mb-3">
        <label class="form-label fw-semibold">Test Result</label>
        <select name="test_result" class="form-select">
          <option value="Pending" {% if test.test_result == 'Pending' %}selected{% endif %}>Pending</option>
          <option value="In Progress" {% if test.test_result == 'In Progress' %}selected{% endif %}>In Progress</option>
          <option value="Completed" {% if test.test_result == 'Completed' %}selected{% endif %}>Completed</option>
        </select>
      </div>

      <!-- Doctor Details -->
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label fw-semibold">Doctor Name</label>
          <input
            type="text"
            class="form-control"
            name="doctor_name"
            value="{{ test.doctor_name or '' }}"
            placeholder="Dr. John Doe"
          >
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label fw-semibold">Doctor Email</label>
          <input
            type="email"
            class="form-control"
            name="doctor_email"
            value="{{ test.doctor_email or '' }}"
            placeholder="doctor@example.com"
          >
        </div>
      </div>

      <!-- Hospital Info -->
      <div class="mb-3">
        <label class="form-label fw-semibold">Hospital / Clinic Name</label>
        <input
          type="text"
          class="form-control"
          name="hospital_name"
          value="{{ test.hospital_name or '' }}"
          placeholder="Hospital or Clinic"
        >
      </div>

      <!-- Test Date -->
      <div class="mb-3">
        <label class="form-label fw-semibold">Test Date</label>
        <input
          type="date"
          name="test_date"
          class="form-control"
          value="{{ test.test_date.strftime('%Y-%m-%d') if test.test_date else '' }}"
        >
      </div>

      <!-- Request Form Upload / View -->
      <div class="mb-3">
        <label class="form-label fw-semibold">Doctorâ€™s Request Form (Optional)</label>
        {% if test.request_form_path %}
          <div class="alert alert-info d-flex justify-content-between align-items-center">
            <span>
              ðŸ“„ <strong>Existing File:</strong>
              <a href="{{ url_for('static', filename=test.request_form_path) }}" target="_blank">View File</a>
            </span>
          </div>
        {% else %}
          <p class="text-muted small mb-1">No file uploaded yet.</p>
        {% endif %}
        <input type="file" name="request_form" class="form-control">
      </div>

      <!-- Verification Info (read-only if exists) -->
      {% if test.is_verified %}
      <div class="alert alert-success mt-3">
        âœ… Verified by 
        <strong>
          {% set verifier = User.query.get(test.verified_by) %}
          {{ verifier.username if verifier else 'Unknown' }}
        </strong> 
        on {{ test.verified_at.strftime('%Y-%m-%d %H:%M') if test.verified_at else '' }}<br>
        <em>{{ test.verified_notes or '' }}</em>
      </div>
      {% endif %}

      <!-- Submit Buttons -->
      <div class="d-flex justify-content-between mt-4">
        <button type="submit" class="btn btn-success px-4">ðŸ’¾ Save Changes</button>
        <a href="{{ url_for('tests.view_tests') }}" class="btn btn-secondary px-4">Cancel</a>
      </div>
    </form>
  </div>
</div>

{% endblock %}

