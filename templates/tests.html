{% extends "base.html" %}
{% block title %}Patient Tests | Lab Management System{% endblock %}
{% block content %}

<div class="container mt-4">
  <h2 class="mb-4 text-center text-primary">Patient Test Records</h2>

  <!-- Add Test Form (with upload support) -->
  {% if current_user.has_permission("add_patient_tests") %}
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
      <h5 class="card-title mb-3 text-primary">Add New Test Record</h5>

      <form method="POST" action="{{ url_for('tests.view_tests') }}" enctype="multipart/form-data">
        <div class="row g-3 mb-3">
          <div class="col-md-3">
            <input type="text" name="patient_name" class="form-control" placeholder="Patient Name" required>
          </div>
          <div class="col-md-3">
            <input type="text" name="test_type" class="form-control" placeholder="Test Type" required>
          </div>
          <div class="col-md-2">
            <select name="test_category" class="form-select">
              <option value="" selected disabled>Select Category</option>
              {% for cat in categories %}
                <option value="{{ cat.id }}">{{ cat.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <select name="test_result" class="form-select">
              <option value="Pending" selected>Pending</option>
              <option value="In Progress">In Progress</option>
              <option value="Completed">Completed</option>
            </select>
          </div>
          <div class="col-md-2">
            <input type="date" name="test_date" class="form-control" value="{{ now().strftime('%Y-%m-%d') }}">
          </div>
        </div>

        <div class="row g-3 align-items-center mb-3">
          <div class="col-md-3">
            <input type="text" name="doctor_name" class="form-control" placeholder="Doctor Name">
          </div>
          <div class="col-md-3">
            <input type="email" name="doctor_email" class="form-control" placeholder="Doctor Email">
          </div>
          <div class="col-md-3">
            <input type="text" name="hospital_name" class="form-control" placeholder="Hospital Name">
          </div>
          <div class="col-md-3">
            <input type="file" name="request_form" class="form-control" accept=".pdf,.png,.jpg,.jpeg">
            <small class="text-muted">Attach doctor's request (PDF or image)</small>
          </div>
        </div>

        <div class="text-end">
          <button type="submit" class="btn btn-success px-4">Add Test</button>
        </div>
      </form>
    </div>
  </div>
  {% endif %}

  <!-- Search Form -->
  <form method="GET" action="{{ url_for('tests.view_tests') }}" class="mb-4">
    <div class="input-group">
      <input
        type="text"
        name="search"
        placeholder="Search by patient name..."
        value="{{ request.args.get('search', '') }}"
        class="form-control"
      >
      <button class="btn btn-outline-primary" type="submit">Search</button>
      <a href="{{ url_for('tests.view_tests') }}" class="btn btn-outline-secondary">Reset</a>
    </div>
  </form>

  <!-- Tests Table -->
  <div class="card shadow-sm border-0">
    <div class="card-body">
      <h5 class="card-title mb-3 text-primary">All Patient Tests</h5>

      {% if tests %}
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Patient Name</th>
              <th>Test Type</th>
              <th>Category</th>
              <th>Result</th>
              <th>Date</th>
              <th>Doctor</th>
              <th>Hospital</th>
              <th>Request Form</th>
              <th>Recorded By</th>
              <th>Verified By</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for test in tests %}
            <tr>
              <td>{{ test.id }}</td>
              <td>{{ test.patient_name }}</td>
              <td>{{ test.test_type }}</td>
              <td>{{ test.category_name or '-' }}</td>
              <td>
                {% if test.test_result == "Pending" %}
                  <span class="badge bg-warning text-dark">Pending</span>
                {% elif test.test_result == "In Progress" %}
                  <span class="badge bg-info text-dark">In Progress</span>
                {% elif test.test_result == "Completed" %}
                  <span class="badge bg-success">Completed</span>
                {% else %}
                  <span class="badge bg-secondary">{{ test.test_result }}</span>
                {% endif %}
              </td>
              <td>{{ test.test_date.strftime('%Y-%m-%d') if test.test_date else 'N/A' }}</td>
              <td>{{ test.doctor_name or '-' }}</td>
              <td>{{ test.hospital_name or '-' }}</td>
              <td>
                {% if test.request_form_path %}
                  <a href="{{ url_for('tests.view_request_form', filename=test.request_form_path.split('/')[-1]) }}"
                     target="_blank"
                     class="btn btn-sm btn-outline-primary">
                    View Form
                  </a>
                {% else %}
                  <span class="text-muted">No File</span>
                {% endif %}
              </td>
              <td>{{ test.user.username if test.user else '-' }}</td>
              <td>
                {% if test.verified_by %}
                  <span class="text-success">{{ verifiers.get(test.verified_by, 'Unknown') }}</span>
                {% else %}
                  <span class="text-muted">Not Verified</span>
                {% endif %}
              </td>
              <td>
                {% if test.status == "verified" %}
                  <span class="badge bg-success">Verified</span>
                {% elif test.status == "entered" %}
                  <span class="badge bg-info text-dark">Entered</span>
                {% elif test.status == "reported" %}
                  <span class="badge bg-primary">Reported</span>
                {% else %}
                  <span class="badge bg-secondary">{{ test.status|capitalize }}</span>
                {% endif %}
              </td>
              <td>
                <div class="d-flex gap-2 flex-wrap">
                  {% if current_user.has_permission("edit_patient_tests") %}
                    <a href="{{ url_for('tests.edit_test', test_id=test.id) }}" class="btn btn-sm btn-outline-warning">‚úè Edit</a>
                  {% endif %}

                  {% if current_user.has_permission("edit_patient_tests") and test.status != "verified" and test.recorded_by != current_user.id %}
                    <form method="POST" action="{{ url_for('tests.verify_test', test_id=test.id) }}" style="display:inline;">
                      <input type="hidden" name="verified_notes" value="Verified by {{ current_user.username }}">
                      <button type="submit" class="btn btn-sm btn-outline-success">Verify</button>
                    </form>
                  {% endif %}

                  {% if current_user.has_permission("edit_patient_tests") and test.is_verified and test.status != "reported" %}
                    <form method="POST" action="{{ url_for('tests.mark_test_reported', test_id=test.id) }}" style="display:inline;">
                      <button type="submit" class="btn btn-sm btn-outline-primary">Mark Reported</button>
                    </form>
                  {% endif %}

                  {% if current_user.has_permission("delete_patient_tests") %}
                    <form method="POST" action="{{ url_for('tests.delete_test', test_id=test.id) }}"
                          onsubmit="return confirm('Are you sure you want to delete this test record?')" style="display:inline;">
                      <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                    </form>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-muted text-center">No test records available.</p>
      {% endif %}
    </div>
  </div>
</div>

{% endblock %}




