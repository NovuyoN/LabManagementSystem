{% extends "base.html" %}
{% block title %}Inventory | Lab Management System{% endblock %}
{% block content %}

<div class="container mt-3">

  <h2 class="mb-4 text-primary">Inventory Management</h2>

  <!-- Alert Banners -->
  {% if expired_items and expired_items|length > 0 %}
  <div class="alert alert-danger d-flex align-items-center" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    <div><strong>{{ expired_items|length }}</strong> item(s) have expired. Please remove or replace stock.</div>
  </div>
  {% endif %}

  {% if expiring_soon_items and expiring_soon_items|length > 0 %}
  <div class="alert alert-warning d-flex align-items-center" role="alert">
    <i class="bi bi-exclamation-circle-fill me-2"></i>
    <div><strong>{{ expiring_soon_items|length }}</strong> item(s) expiring within 14 days.</div>
  </div>
  {% endif %}

  {% if out_of_stock_items and out_of_stock_items|length > 0 %}
  <div class="alert alert-dark d-flex align-items-center" role="alert">
    <i class="bi bi-bag-x-fill me-2"></i>
    <div><strong>{{ out_of_stock_items|length }}</strong> item(s) are out of stock.</div>
  </div>
  {% endif %}

  {% if low_stock_items and low_stock_items|length > 0 %}
  <div class="alert alert-info d-flex align-items-center" role="alert">
    <i class="bi bi-arrow-down-circle-fill me-2"></i>
    <div><strong>{{ low_stock_items|length }}</strong> item(s) below reorder level.</div>
  </div>
  {% endif %}

  <!-- Add Item Form -->
  {% if current_user.has_permission("manage_inventory") %}
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
      <h5 class="card-title text-secondary fw-semibold mb-3">Add New Item</h5>
      <form method="POST" action="{{ url_for('inventory.inventory') }}" class="row g-3">
        <div class="col-md-3">
          <input type="text" name="item_name" placeholder="Item name" class="form-control" required>
        </div>
        <div class="col-md-2">
          <input type="text" name="category" placeholder="Category (e.g., Reagent)" class="form-control">
        </div>
        <div class="col-md-2">
          <input type="text" name="unit" placeholder="Unit (e.g., bottles)" class="form-control">
        </div>
        <div class="col-md-2">
          <input type="number" name="quantity" placeholder="Qty" class="form-control" min="0" required>
        </div>
        <div class="col-md-1">
          <input type="number" name="min_threshold" placeholder="Min" class="form-control" min="0" title="Reorder level">
        </div>
        <div class="col-md-2">
          <input type="date" name="expiry_date" class="form-control" title="Expiry Date (applies to all items)">
        </div>
        <div class="col-12 text-end">
          <button type="submit" class="btn btn-success">
            <i class="bi bi-plus-circle"></i> Add Item
          </button>
        </div>
      </form>
    </div>
  </div>
  {% endif %}

  <!-- Search Bar -->
  <form method="GET" action="{{ url_for('inventory.inventory') }}" class="mb-3">
    <div class="input-group">
      <input type="text" name="search" placeholder="Search by name, category, or unit..." class="form-control" value="{{ request.args.get('search', '') }}">
      <button class="btn btn-outline-primary" type="submit"><i class="bi bi-search"></i> Search</button>
      <a href="{{ url_for('inventory.inventory') }}" class="btn btn-outline-secondary">Reset</a>
    </div>
  </form>

  <!-- Inventory Table -->
  <div class="card shadow-sm border-0">
    <div class="card-body">
      <h5 class="card-title text-secondary fw-semibold mb-3">All Items</h5>

      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Item Name</th>
              <th>Category</th>
              <th>Unit</th>
              <th class="text-end">Qty</th>
              <th class="text-end">Min</th>
              <th>Expiry</th>
              <th>Status</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for item in items %}
            {% set status = statuses.get(item.id, 'In Stock') %}
            <tr
              {% if status == 'Expired' %} class="table-danger"
              {% elif status == 'Expiring Soon' %} class="table-warning"
              {% elif status == 'Out of Stock' %} class="table-secondary"
              {% elif status == 'Low Stock' %} class="table-info"
              {% endif %}
            >
              <td>{{ item.id }}</td>
              <td class="fw-semibold">{{ item.item_name }}</td>
              <td>{{ item.category or '-' }}</td>
              <td>{{ item.unit or 'units' }}</td>
              <td class="text-end">{{ item.quantity }}</td>
              <td class="text-end">{{ item.min_threshold if item.min_threshold is not none else '-' }}</td>
              <td>
                {% if item.expiry_date %}
                  {{ item.expiry_date.strftime('%Y-%m-%d') }}
                {% else %}
                  <span class="text-muted">â€”</span>
                {% endif %}
              </td>
              <td>
                {% if status == 'Expired' %}
                  <span class="badge bg-danger"><i class="bi bi-exclamation-triangle"></i> {{ status }}</span>
                {% elif status == 'Expiring Soon' %}
                  <span class="badge bg-warning text-dark"><i class="bi bi-exclamation-circle"></i> {{ status }}</span>
                {% elif status == 'Out of Stock' %}
                  <span class="badge bg-secondary"><i class="bi bi-bag-x"></i> {{ status }}</span>
                {% elif status == 'Low Stock' %}
                  <span class="badge bg-info text-dark"><i class="bi bi-arrow-down-circle"></i> {{ status }}</span>
                {% else %}
                  <span class="badge bg-success"><i class="bi bi-check-circle"></i> {{ status }}</span>
                {% endif %}
              </td>
              <td class="text-end">
                {% if current_user.has_permission('manage_inventory') %}
                  <a href="{{ url_for('inventory.edit_inventory', item_id=item.id) }}" class="btn btn-sm btn-outline-warning">
                    <i class="bi bi-pencil-square"></i> Edit
                  </a>
                  <form method="POST" action="{{ url_for('inventory.delete_inventory', item_id=item.id) }}"
                        onsubmit="return confirm('Delete this item?')" style="display:inline;">
                    <button type="submit" class="btn btn-sm btn-outline-danger">
                      <i class="bi bi-trash"></i> Delete
                    </button>
                  </form>
                {% else %}
                  <span class="text-muted">No Actions</span>
                {% endif %}
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="9" class="text-center text-muted">No inventory items found.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    </div>
  </div>

</div>

{% endblock %}
